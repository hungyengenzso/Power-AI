<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TVPower Check | Chatbot Tiết kiệm Điện</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

    <script>
        // Initialize Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAkQmLs3LiuigjfPm-IfUBQHA9R_bs6Kbk",
  authDomain: "scan-text-f0a13.firebaseapp.com",
  projectId: "scan-text-f0a13",
  storageBucket: "scan-text-f0a13.firebasestorage.app",
  messagingSenderId: "698160614553",
  appId: "1:698160614553:web:984e6e59bed8f93a74fc08",
  measurementId: "G-C1EYX3NNLS"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        
        // Check authentication state
        auth.onAuthStateChanged(user => {
            if (!user) {
                // User is not logged in, redirect to index.html
                window.location.href = 'index.html';
            }
        });

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#2c82c9',
                        secondary: '#1e1b4b',
                        accent: '#4caf50',
                        light: {
                            bg: '#ffffff',
                            text: '#333333',
                            sidebar: '#f8f9fa',
                            hover: '#e9ecef'
                        }
                    },
                    fontFamily: {
                        sans: ['Calibri', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Header styles from code 1 */
        .header {
            background: linear-gradient(135deg, #4caefe, #2d87e0);
            color: white;
            padding: 12px 5%;
            display: flex;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            flex-shrink: 0;
            margin-right: auto;
            cursor: pointer;
        }
        
        .logo i {
            font-size: 24px;
            margin-right: 8px;
        }
        
        .logo-text {
            font-weight: bold;
            font-size: 18px;
            white-space: nowrap;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            margin-left: auto;
        }
        
        .search-container {
            display: flex;
            align-items: center;
            margin: 0 15px;
        }
        
        .search-input {
            width: 0;
            padding: 0;
            border-radius: 20px;
            border: none;
            outline: none;
            font-size: 14px;
            transition: all 0.3s ease;
            opacity: 0;
            visibility: hidden;
        }
        
        .search-input.active {
            width: 200px;
            padding: 8px 15px;
            opacity: 1;
            visibility: visible;
            margin-right: 10px;
        }
        
        .search-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            flex-shrink: 0;
            transition: transform 0.2s;
        }
        
        .search-toggle:hover {
            transform: scale(1.1);
        }
        
        .notification {
            position: relative;
            flex-shrink: 0;
            margin-left: 15px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .notification:hover {
            transform: scale(1.1);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        .auth-buttons {
            display: flex;
            align-items: center;
            margin-left: 15px;
        }
        
        .auth-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 14px;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }
        
        .auth-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .auth-icon {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s;
        }
        
        .auth-icon:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-left: 10px;
            cursor: pointer;
            object-fit: cover;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Rest of code 2 styles */
        body {
            font-family: 'Calibri', sans-serif;
            background-color: #ffffff;
            color: #333333;
        }
        
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .typing-dots::after {
            content: '...';
            animation: typing 1.5s infinite;
        }
        
        @keyframes typing {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        
        .code-block {
            position: relative;
            margin: 1rem 0;
            border-radius: 0.75rem;
            overflow: hidden;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        
        .code-header {
            font-family: monospace;
            user-select: none;
        }
        
        .copy-code-btn {
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .copy-code-btn:hover {
            color: #2c82c9;
        }
        
        pre {
            margin: 0 !important;
            padding: 1rem !important;
            background-color: #f8f9fa !important;
            border-radius: 0 0 0.75rem 0.75rem;
        }
        
        .markdown p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        
        .markdown ul, .markdown ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }
        
        .markdown li {
            margin-bottom: 0.5rem;
        }
        
        .markdown code:not(pre code) {
            background-color: #e9ecef;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: monospace;
            color: #333333;
        }
        
        .markdown strong {
            font-weight: 600;
        }
        
        .markdown em {
            font-style: italic;
        }
        
        .markdown h1, .markdown h2, .markdown h3, .markdown h4 {
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .markdown h1 {
            font-size: 1.5rem;
            line-height: 2rem;
        }
        
        .markdown h2 {
            font-size: 1.25rem;
            line-height: 1.75rem;
        }
        
        .markdown h3 {
            font-size: 1.125rem;
            line-height: 1.75rem;
        }
        
        .markdown h4 {
            font-size: 1rem;
            line-height: 1.5rem;
        }
        
        .markdown table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            border-radius: 0.75rem;
            overflow: hidden;
        }
        
        .markdown th, .markdown td {
            padding: 0.5rem 1rem;
            border: 1px solid #e9ecef;
            text-align: left;
        }
        
        .markdown th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .markdown blockquote {
            border-left: 4px solid #ced4da;
            padding-left: 1rem;
            margin: 1rem 0;
            color: #6c757d;
            border-radius: 0.75rem;
            background-color: #f8f9fa;
        }
        
        .user-message {
            align-self: flex-end;
            background-color: #2c82c9;
            color: white;
            border-radius: 1rem 1rem 0 1rem;
            max-width: 80%;
            margin-left: auto;
            padding: 0.75rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .bot-message {
            align-self: flex-start;
            background-color: #f8f9fa;
            border-radius: 1rem 1rem 1rem 0;
            max-width: 80%;
            margin-right: auto;
            padding: 0.75rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }
        
        .typing-indicator {
            align-self: flex-start;
            background-color: #f8f9fa;
            border-radius: 1rem 1rem 1rem 0;
            max-width: 80%;
            margin-right: auto;
            padding: 0.75rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }
        
        .message-content {
            word-wrap: break-word;
            white-space: pre-wrap;
            border-radius: 0.5rem;
            padding: 0.5rem;
        }
        
        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
        
        .suggestions-container {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding: 0.5rem 0;
            margin-bottom: 0.5rem;
            scrollbar-width: none;
        }
        
        .suggestions-container::-webkit-scrollbar {
            display: none;
        }
        
        .suggestion-chip {
            background-color: #e9ecef;
            border-radius: 1rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .suggestion-chip:hover {
            background-color: #2c82c9;
            color: white;
        }
        
        .loading-spinner {
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .navbar {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 50;
        }
        
        .menu-toggle {
            display: none;
            cursor: pointer;
            color: #2c82c9;
            font-size: 1.25rem;
            padding: 0.5rem;
        }
        
        .sidebar-toggle {
            display: none;
            cursor: pointer;
            color: #2c82c9;
            font-size: 1.25rem;
            padding: 0.5rem;
            position: absolute;
            left: 1rem;
        }
        
        .nav-menu {
            display: flex;
        }
        
        .nav-menu ul {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .nav-menu ul li {
            position: relative;
        }
        
        .nav-menu ul li a {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: #333;
            text-decoration: none;
            transition: all 0.2s;
            border-radius: 0.5rem;
        }
        
        .nav-menu ul li a:hover {
            background-color: #e9ecef;
            color: #2c82c9;
        }
        
        .nav-menu ul li a i {
            margin-right: 0.5rem;
            font-size: 1rem;
        }
        
        .nav-menu ul li.active a {
            background-color: #2c82c9;
            color: white;
        }
        
        @media (max-width: 768px) {
            .menu-toggle {
                display: block;
            }
            
            .sidebar-toggle {
                display: block;
            }
            
            .nav-menu {
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background-color: white;
                box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
                display: none;
                z-index: 1000;
                padding: 1rem;
            }
            
            .nav-menu.active {
                display: block;
            }
            
            .nav-menu ul {
                flex-direction: column;
                width: 100%;
            }
            
            .nav-menu ul li {
                width: 100%;
            }
            
            .nav-menu ul li a {
                padding: 0.75rem;
                border-radius: 0.5rem;
            }
            
            #sidebar {
                position: absolute;
                left: -100%;
                transition: left 0.3s ease;
                z-index: 40;
                height: calc(100vh - 4rem);
                top: 4rem;
            }
            
            #sidebar.active {
                left: 0;
            }
            
            .logo span {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            .logo i {
                font-size: 1.5rem;
            }
            
            .menu-toggle, .sidebar-toggle {
                font-size: 1.1rem;
                padding: 0.5rem;
            }
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .auth-btn span {
                display: none;
            }
            
            .auth-btn i {
                margin-right: 0;
            }
            
            .auth-btn {
                width: 36px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0;
                border-radius: 50%;
            }
            
            .search-input.active {
                width: 150px;
            }
            
            .header {
                padding: 12px 3%;
            }
            
            .search-container {
                margin: 0 10px;
            }
            
            .notification {
                margin-left: 10px;
            }
            
            .auth-buttons {
                margin-left: 10px;
            }
        }

        @media (min-width: 768px) {
            .header {
                padding: 15px 8%;
            }
            
            .logo i {
                font-size: 28px;
            }
            
            .logo-text {
                font-size: 20px;
            }
            
            .search-toggle {
                font-size: 20px;
            }
            
            .notification i {
                font-size: 20px;
            }
            
            .search-input.active {
                width: 250px;
            }
        }

        @media (min-width: 992px) {
            .header {
                padding: 18px 10%;
            }
            
            .logo i {
                font-size: 32px;
            }
            
            .logo-text {
                font-size: 22px;
            }
            
            .search-input.active {
                width: 300px;
            }
        }
    </style>
</head>
<body class="h-screen flex flex-col bg-light-bg text-light-text transition-all">

    <!-- Header from code 1 -->
    <div class="header">
        <div class="logo" onclick="window.location.href='index.html'">
            <i class="fa-solid fa-bolt"></i>
            <span class="logo-text">TVPower Check</span>
        </div>
        
        <div class="header-right">
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Tìm kiếm dịch vụ...">
                <button class="search-toggle">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <div class="notification">
                <i class="fa fa-bell"></i>
                <span class="notification-badge">3</span>
            </div>
            
            <!-- Auth buttons will be inserted here by JavaScript -->
            <div class="auth-buttons" id="authButtons"></div>
        </div>
    </div>

    <!-- Navbar with sidebar toggle -->
    <div class="navbar flex items-center justify-between px-4 py-2">
        <button class="sidebar-toggle md:hidden" id="mobileSidebarToggle">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="flex items-center gap-2">
            <button class="menu-toggle md:hidden" id="mobileMenuToggle">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </div>
        
        <div class="nav-menu">
            <ul>
                <li class="active">
                    <a href="#">
                        <i class="fas fa-comment"></i>
                        <span>Trò chuyện</span>
                    </a>
                </li>
                <li>
                    <a href="#">
                        <i class="fas fa-chart-line"></i>
                        <span>Phân tích</span>
                    </a>
                </li>
                <li>
                    <a href="#">
                        <i class="fas fa-lightbulb"></i>
                        <span>Gợi ý</span>
                    </a>
                </li>
                <li>
                    <a href="#">
                        <i class="fas fa-cog"></i>
                        <span>Cài đặt</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <div id="app" class="flex flex-1 overflow-hidden">

        <div id="sidebar" class="w-48 bg-light-sidebar shadow-lg border-r border-gray-200 flex flex-col h-full md:relative absolute">

            <div class="p-3">
                <button id="new-chat-btn" class="w-full flex items-center justify-center gap-2 bg-primary hover:bg-primary/90 text-white rounded-md transition px-4 py-2">
                    <i class="fa-solid fa-file-circle-plus"></i>
                    <span>Cuộc trò chuyện mới</span>
                </button>
            </div>
            
            <div id="chat-history" class="flex-1 overflow-y-auto hide-scrollbar p-2">
                <!-- Chat history will be populated here -->
            </div>
            
            <div class="p-3 border-t border-gray-200">
                <div class="text-center text-sm text-gray-500">
                    <p>©2025 THPT Trưng Vương</p>
                    <p>Dự án TVPower Check</p>
                </div>
            </div>
        </div>
        
        <div class="flex-1 flex flex-col h-full overflow-hidden">
            <div id="chat-container" class="flex-1 overflow-y-auto hide-scrollbar p-4 bg-white flex flex-col gap-3">
                <div id="chat-messages" class="flex flex-col gap-3 mx-auto max-w-3xl w-full">
                    <!-- Messages will appear here -->
                </div>
            </div>
            
            <div id="typing-indicator" class="hidden max-w-3xl mx-auto p-4 mb-4">
                <div class="flex items-center gap-2">
                    <div class="loading-spinner"></div>
                    <span class="text-gray-600">AI đang suy nghĩ, vui lòng đợi giây lát</span>
                </div>
            </div>
            
            <div id="suggestions-bar" class="hidden max-w-3xl mx-auto w-full px-4">
                <div class="text-sm text-gray-500 mb-1">Gợi ý:</div>
                <div id="suggestions-container" class="suggestions-container">
                    <!-- Suggested questions will appear here -->
                </div>
            </div>

            <div class="p-4 border-t border-gray-200 bg-white">
                <div class="max-w-3xl mx-auto">
                    <form id="chat-form" class="relative">
                        <textarea 
                            id="message-input" 
                            class="w-full p-4 rounded-lg border border-gray-300 bg-white resize-none focus:outline-none focus:ring-2 focus:ring-primary text-gray-800"
                            placeholder="Nhập câu hỏi về tiết kiệm điện..."
                            rows="1"
                        ></textarea>
                        <button 
                            id="send-button" 
                            type="submit" 
                            class="absolute right-3 bottom-3 w-10 h-10 flex items-center justify-center bg-primary hover:bg-primary/90 text-white rounded-full transition"
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script>
const energyKeywords = [
    "điện", "tiết kiệm", "năng lượng", "điện năng", "công suất", "thiết bị", 
    "hóa đơn", "EVN", "điện lực", "tính toán", "chi phí", "sử dụng", 
    "công tơ", "kWh", "W", "kW", "đèn", "tủ lạnh", "máy lạnh", 
    "quạt", "TV", "máy giặt", "bình nóng lạnh", "inverter", "công nghệ", 
    "xanh", "tái tạo", "mặt trời", "gió", "thủy điện", "nhiệt điện", 
    "phí điện", "bậc thang", "giá điện", "điện sinh hoạt", "điện kinh doanh", 
    "điện sản xuất", "cắt giảm", "tối ưu", "hiệu suất", "tiêu thụ", 
    "đo lường", "kiểm tra", "đánh giá", "so sánh", "khuyến nghị", 
    "giải pháp", "tư vấn", "hướng dẫn", "cách tính", "công thức", 
    "chỉ số", "đồng hồ", "smart meter", "thông minh", "tự động", 
    "điều khiển", "hẹn giờ", "cảm biến", "ánh sáng", "nhiệt độ", 
    "độ ẩm", "thông gió", "cách nhiệt", "vật liệu", "kiến trúc", 
    "xây dựng", "thiết kế", "lắp đặt", "bảo trì", "vệ sinh", 
    "nâng cấp", "thay thế", "mua sắm", "lựa chọn", "tiêu chuẩn", 
    "chứng chỉ", "ENERGY STAR", "tiết kiệm điện", "giảm tiêu thụ", 
    "tối ưu hóa", "hiệu quả năng lượng", "quản lý điện", "kiểm soát", 
    "phân tích", "báo cáo", "thống kê", "xu hướng", "biểu đồ", 
    "theo dõi", "giám sát", "cảnh báo", "thông báo", "khuyến cáo", "chào"
];

function isEnergyQuestion(question) {
    const lowerQuestion = question.toLowerCase();
    return energyKeywords.some(keyword => lowerQuestion.includes(keyword.toLowerCase()));
}

function generateSuggestions(messages) {
    const userMessages = messages.filter(msg => msg.role === "user");
    if (userMessages.length === 0) {
        return [
            "Cách tính tiền điện theo bậc thang?",
            "Làm sao để tiết kiệm điện cho máy lạnh?",
            "Công thức tính công suất điện tiêu thụ?",
            "So sánh đèn LED và đèn compact"
        ];
    }
    
    // Simple logic to generate follow-up questions based on previous messages
    const lastMessage = userMessages[userMessages.length - 1].content;
    
    if (lastMessage.includes("tính")) {
        return [
            "Bạn có thể hướng dẫn chi tiết cách tính này không?",
            "Công thức này áp dụng cho những thiết bị nào?",
            "Có cách nào tối ưu hóa việc tính toán không?"
        ];
    } else if (lastMessage.includes("tiết kiệm")) {
        return [
            "Những thiết bị nào tiêu thụ nhiều điện nhất?",
            "Mẹo tiết kiệm điện cho từng loại thiết bị",
            "Công nghệ Inverter có thực sự tiết kiệm điện?"
        ];
    } else if (lastMessage.includes("thiết bị")) {
        return [
            "Cách chọn thiết bị tiết kiệm điện",
            "Bảng so sánh công suất các thiết bị phổ biến",
            "Tuổi thọ và hiệu suất năng lượng của thiết bị"
        ];
    }
    
    return [
        "Bạn có thể giải thích rõ hơn về điều này không?",
        "Có giải pháp nào tối ưu hơn không?",
        "Tôi nên làm gì để áp dụng điều này hiệu quả?"
    ];
}

class EnergyAI {
    constructor() {
        this.endpoint = "https://api.energy-ai.example.com/v1/chat";
        this.conversationHistory = [];
    }

    async sendQuery(userInput, previousMessages = []) {
        if (!isEnergyQuestion(userInput)) {
            return {
                success: false,
                message: "Xin lỗi, tôi chỉ trả lời chuyên về các câu hỏi liên quan đến tiết kiệm điện và năng lượng. Bạn có câu hỏi nào về lĩnh vực này không?"
            };
        }
        try {
            const response = await this.mockApiCall(userInput, previousMessages);
            return response;
        } catch (error) {
            console.error("API Error:", error);
            if (error.message.includes("không thuộc chủ đề")) {
                return {
                    success: false,
                    message: "Xin lỗi, tôi chỉ trả lời chuyên về các câu hỏi liên quan đến tiết kiệm điện và năng lượng. Bạn có câu hỏi nào về lĩnh vực này không?"
                };
            } else {
                throw new Error("Lỗi kết nối! Vui lòng thử lại sau.");
            }
        }
    }

    async mockApiCall(userInput, history) {
        if (!isEnergyQuestion(userInput)) {
            return {
                success: false,
                message: "Xin lỗi, tôi chỉ trả lời chuyên về các câu hỏi liên quan đến tiết kiệm điện và năng lượng. Bạn có câu hỏi nào về lĩnh vực này không?"
            };
        }
        
        await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
        
        const energyResponses = [
            "Để tiết kiệm điện cho thiết bị này, bạn nên...",
            "Theo tính toán, bạn có thể giảm chi phí điện bằng cách...",
            "Công suất tiêu thụ điện của thiết bị này khoảng...",
            "So sánh với các thiết bị cùng loại, model này tiết kiệm hơn...",
            "Giá điện bậc thang hiện nay được tính như sau...",
            "Để tối ưu hóa hiệu suất năng lượng, bạn có thể...",
            "Theo nghiên cứu, việc sử dụng thiết bị này vào ban đêm sẽ...",
            "Công nghệ Inverter giúp tiết kiệm điện bằng cách...",
            "Bạn có thể tính toán lượng điện tiêu thụ theo công thức..."
        ];
        
        const randomResponse = energyResponses[Math.floor(Math.random() * energyResponses.length)];
        const enhancedResponse = `${randomResponse}\n\nĐây là thông tin từ hệ thống TVPower Check của THPT Trưng Vương, chuyên về tiết kiệm điện và năng lượng.`;
        
        return {
            success: true,
            data: {
                response: enhancedResponse
            }
        };
    }
}
    </script>
    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai"
            }
        }
    </script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        const API_KEY = "AIzaSyDN3FpLLxpue1y481xaIhrASCVpqbKxvdQ";
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash-thinking-exp-01-21" });

        const chatContainer = document.getElementById('chat-container');
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatHistory = document.getElementById('chat-history');
        const typingIndicator = document.getElementById('typing-indicator');
        const suggestionsBar = document.getElementById('suggestions-bar');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const sendButton = document.getElementById('send-button');
        const menuToggle = document.getElementById('mobileMenuToggle');
        const navMenu = document.querySelector('.nav-menu');
        const sidebarToggle = document.getElementById('mobileSidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const searchToggle = document.querySelector('.search-toggle');
        const searchInput = document.querySelector('.search-input');
        const authButtons = document.getElementById('authButtons');

        let chats = [];
        let currentChatId = null;
        let isSending = false;
        let typingInterval = null;
        let isStopped = false;

        // Check screen width
        function isMobile() {
            return window.innerWidth <= 600;
        }

        // Auth state observer
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in
                authButtons.innerHTML = `
                    <button class="auth-btn" onclick="logout()" title="Đăng xuất">
                        <i class="fas fa-sign-out-alt"></i>
                        ${isMobile() ? '' : '<span>Đăng xuất</span>'}
                    </button>
                    ${user.photoURL ? 
                        `<img src="${user.photoURL}" class="user-avatar" title="${user.displayName || user.email}">` : 
                        `<span class="auth-btn" title="${user.displayName || user.email}">
                            <i class="fas fa-user"></i>
                            ${isMobile() ? '' : `<span>${user.displayName || user.email.split('@')[0]}</span>`}
                        </span>`}
                `;
            } else {
                // User is signed out
                window.location.href = 'index.html';
            }
        });

        // Logout function
        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            }).catch(error => {
                console.error('Logout error:', error);
            });
        }

        function initApp() {
            loadChats();
            setupEventListeners();
            setupTextareaAutoResize();

            if (chats.length === 0) {
                createNewChat();
            } else {
                loadChat(chats[0].id);
            }
        }

        function setupEventListeners() {
            chatForm.addEventListener('submit', handleSubmit);
            messageInput.addEventListener('input', autoResizeTextarea);
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (messageInput.value.trim() !== '') {
                        chatForm.dispatchEvent(new Event('submit'));
                    }
                }
            });
            newChatBtn.addEventListener('click', createNewChat);
            
            // Setup menu toggle
            menuToggle.addEventListener('click', () => {
                navMenu.classList.toggle('active');
                // Close sidebar if open
                sidebar.classList.remove('active');
            });
            
            // Setup sidebar toggle
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                // Close menu if open
                navMenu.classList.remove('active');
            });
            
            // Close menu when clicking on nav items
            document.querySelectorAll('.nav-menu a').forEach(link => {
                link.addEventListener('click', () => {
                    navMenu.classList.remove('active');
                });
            });
            
            // Close sidebar when clicking outside
            document.addEventListener('click', (e) => {
                if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
                    sidebar.classList.remove('active');
                }
                if (!navMenu.contains(e.target) && !menuToggle.contains(e.target)) {
                    navMenu.classList.remove('active');
                }
            });

            // Search functionality
            searchToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                searchInput.classList.toggle('active');
                if (searchInput.classList.contains('active')) {
                    searchInput.focus();
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container') && searchInput.classList.contains('active')) {
                    searchInput.classList.remove('active');
                }
            });
        }

        function setupTextareaAutoResize() {
            messageInput.style.height = 'auto';
            const newHeight = Math.min(messageInput.scrollHeight, 150);
            messageInput.style.height = `${newHeight}px`;
        }

        function autoResizeTextarea() {
            messageInput.style.height = 'auto';
            const newHeight = Math.min(messageInput.scrollHeight, 150);
            messageInput.style.height = `${newHeight}px`;
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const userMessage = messageInput.value.trim();
            if (!userMessage || isSending) return;

            if (!isEnergyQuestion(userMessage)) {
                addMessageToUI("assistant", "Xin lỗi, tôi chỉ trả lời chuyên về các câu hỏi liên quan đến tiết kiệm điện và năng lượng. Bạn có câu hỏi nào về lĩnh vực này không?");
                messageInput.value = "";
                autoResizeTextarea();
                return;
            }

            if (!currentChatId) {
                createNewChat();
                return;
            }

            const currentChat = chats.find(chat => chat.id === currentChatId);
            if (!currentChat) {
                console.error("Không tìm thấy cuộc trò chuyện hiện tại!");
                return;
            }

            isSending = true;
            addMessageToUI("user", userMessage);
            
            // Change send button to stop button
            sendButton.innerHTML = '<div class="loading-spinner"></div>';
            sendButton.setAttribute('data-action', 'stop');
            sendButton.onclick = stopGeneration;

            const greetings = ["chào", "hello"];
            if (greetings.some(greet => userMessage.toLowerCase().includes(greet))) {
                const greetingResponse = "Xin chào, tôi là TVPower Check - trợ lý ảo về tiết kiệm điện của trường THPT Trưng Vương. Tôi có thể giúp gì cho bạn về tiết kiệm điện và năng lượng ngay bây giờ?";
                displayTypingMessage(greetingResponse, () => {
                    if (!isStopped) {
                        currentChat.messages.push({ 
                            role: "assistant", 
                            content: greetingResponse,
                            timestamp: new Date().toISOString()
                        });
                        saveChats();
                        updateSuggestions(currentChat.messages);
                    }
                });
                messageInput.value = "";
                autoResizeTextarea();
                isSending = false;
                resetSendButton();
                return;
            }

            currentChat.messages.push({ 
                role: "user", 
                content: userMessage,
                timestamp: new Date().toISOString()
            });

            saveChats();
            updateChatTitle(currentChat);

            messageInput.value = "";
            autoResizeTextarea();
            typingIndicator.classList.remove("hidden");
            isStopped = false;

            try {
                const chatSession = model.startChat({
                    history: currentChat.messages.map(msg => ({
                        role: msg.role === "user" ? "user" : "model",
                        parts: [{ text: msg.content }]
                    })),
                    generationConfig: {
                        maxOutputTokens: 2000,
                        temperature: 0.9,
                        topP: 0.1,
                        topK: 16,
                    }
                });

                const result = await chatSession.sendMessage(userMessage);
                const response = await result.response;
                const botReply = response.text();

                displayTypingMessage(botReply, () => {
                    if (!isStopped) {
                        currentChat.messages.push({ 
                            role: "assistant", 
                            content: botReply,
                            timestamp: new Date().toISOString()
                        });
                        saveChats();
                        updateSuggestions(currentChat.messages);
                    }
                });
            } catch (error) {
                console.error("Lỗi: ", error);
                addMessageToUI("assistant", "Lỗi kết nối! Vui lòng thử lại sau.");
            } finally {
                isSending = false;
                typingIndicator.classList.add("hidden");
                resetSendButton();
                scrollToBottom();
            }
        }

        function stopGeneration(e) {
            e.preventDefault();
            isStopped = true;
            if (typingInterval) {
                clearInterval(typingInterval);
                typingInterval = null;
            }
            resetSendButton();
        }

        function resetSendButton() {
            sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
            sendButton.setAttribute('data-action', 'send');
            sendButton.onclick = null;
        }

        function updateSuggestions(messages) {
            const suggestions = generateSuggestions(messages);
            suggestionsContainer.innerHTML = '';
            
            if (suggestions.length > 0) {
                suggestions.forEach(suggestion => {
                    const chip = document.createElement('div');
                    chip.className = 'suggestion-chip';
                    chip.textContent = suggestion;
                    chip.addEventListener('click', () => {
                        messageInput.value = suggestion;
                        messageInput.focus();
                        autoResizeTextarea();
                    });
                    suggestionsContainer.appendChild(chip);
                });
                suggestionsBar.classList.remove('hidden');
            } else {
                suggestionsBar.classList.add('hidden');
            }
        }

        function displayTypingMessage(content, callback) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'bot-message';
            messageDiv.innerHTML = '<div class="message-content"></div>';
            chatMessages.appendChild(messageDiv);
            scrollToBottom();

            let i = 0;
            const speed = 10;
            const contentDiv = messageDiv.querySelector('.message-content');

            if (typingInterval) clearInterval(typingInterval);
            
            typingIndicator.classList.remove("hidden");
            typingInterval = setInterval(() => {
                if (isStopped) {
                    clearInterval(typingInterval);
                    typingInterval = null;
                    contentDiv.innerHTML = formatMessage(content.substring(0, i));
                    typingIndicator.classList.add("hidden");
                    if (callback) callback();
                    return;
                }

                if (i < content.length) {
                    contentDiv.innerHTML = formatMessage(content.substring(0, i + 1));
                    i++;
                    scrollToBottom();
                } else {
                    clearInterval(typingInterval);
                    typingInterval = null;
                    typingIndicator.classList.add("hidden");
                    if (callback) callback();
                }
            }, speed);
        }

        function addMessageToUI(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = role === 'user' ? 'user-message' : 'bot-message';
            
            const formattedContent = formatMessage(content);
            messageDiv.innerHTML = `<div class="message-content">${formattedContent}</div>`;
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function formatMessage(content) {
            if (!content) return '';

            let formatted = content.replace(/```([\w]*)\n([\s\S]*?)```/g, (match, lang, code) => {
                const langDisplay = lang ? lang : 'text';
                return `<div class="code-block">
                    <div class="code-header flex justify-between items-center px-3 py-2 bg-gray-100 text-gray-600 text-xs rounded-t-md">
                        <span>${langDisplay}</span>
                        <button class="copy-code-btn hover:text-primary" onclick="copyToClipboard(this)" data-code="${encodeURIComponent(code.trim())}">
                            <i class="fas fa-copy"></i> Copy code
                        </button>
                    </div>
                    <pre><code class="language-${lang || 'text'}">${escapeHtml(code.trim())}</code></pre>
                </div>`;
            });

            formatted = formatted.replace(/\|(.+)\|\n\|(?:[-:]+\|)+\n((?:\|.+\|\n)+)/g, (match) => {
                return `<div class="overflow-x-auto"><table class="w-full">
                    ${match.replace(/\|(.+)\|\n\|(?:[-:]+\|)+\n/, (header) => {
                        const headerCells = header.split('|').slice(1, -1);
                        return `<thead><tr>${headerCells.map(cell => `<th class="px-4 py-2">${cell.trim()}</th>`).join('')}</tr></thead>`;
                    })}
                    <tbody>
                        ${match.split('\n').slice(2).filter(Boolean).map(row => {
                            const cells = row.split('|').slice(1, -1);
                            return `<tr>${cells.map(cell => `<td class="px-4 py-2">${cell.trim()}</td>`).join('')}</tr>`;
                        }).join('')}
                    </tbody>
                </table></div>`;
            });

            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            formatted = formatted.replace(/`([^`]+)`/g, '<code class="bg-gray-100 px-1 py-0.5 rounded">$1</code>');

            formatted = formatted.split('\n\n').map(paragraph => {
                if (paragraph.trim().startsWith('<') && paragraph.trim().endsWith('>')) {
                    return paragraph;
                }
                return `<p>${paragraph}</p>`;
            }).join('');

            formatted = formatted.replace(/\n(?![<])/g, '<br>');

            return formatted;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function scrollToBottom() {
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        }

        function createNewChat() {
            const newChat = {
                id: Date.now().toString(),
                title: 'Cuộc trò chuyện mới',
                messages: [],
                createdAt: new Date().toISOString()
            };

            chats.unshift(newChat);
            saveChats();
            renderChatHistory();
            loadChat(newChat.id);
            
            messageInput.focus();
            suggestionsBar.classList.add('hidden');
        }

        function loadChat(chatId) {
            currentChatId = chatId;

            document.querySelectorAll('.chat-item').forEach(item => {
                if (item.dataset.id === chatId) {
                    item.classList.add('bg-light-hover');
                } else {
                    item.classList.remove('bg-light-hover');
                }
            });

            chatMessages.innerHTML = '';

            const currentChat = chats.find(chat => chat.id === chatId);
            if (!currentChat) return;

            if (currentChat.messages.length > 0) {
                currentChat.messages.forEach(message => {
                    addMessageToUI(message.role, message.content);
                });
                updateSuggestions(currentChat.messages);
            } else {
                suggestionsBar.classList.add('hidden');
            }
            
            scrollToBottom();
        }

        function deleteChat(chatId, event) {
            event.stopPropagation();
            chats = chats.filter(chat => chat.id !== chatId);
            saveChats();
            renderChatHistory();

            if (chatId === currentChatId) {
                if (chats.length > 0) {
                    loadChat(chats[0].id);
                } else {
                    createNewChat();
                }
            }
        }

        function updateChatTitle(chat) {
            if (!chat || !chat.messages || chat.messages.length === 0) {
                chat.title = "Cuộc trò chuyện mới";
                saveChats();
                renderChatHistory();
                return;
            }

            const firstUserMessage = chat.messages.find(msg => msg.role === "user");
            if (firstUserMessage) {
                let title = firstUserMessage.content.substring(0, 40);
                if (firstUserMessage.content.length > 40) {
                    title += "...";
                }
                chat.title = title || "Cuộc trò chuyện mới";
            } else {
                chat.title = "Cuộc trò chuyện mới";
            }

            saveChats();
            renderChatHistory();
        }

        function renderChatHistory() {
            chatHistory.innerHTML = '';

            if (chats.length === 0) {
                chatHistory.innerHTML = `
                    <div class="text-center p-4 text-gray-400">
                        Chưa có cuộc trò chuyện nào
                    </div>
                `;
                return;
            }

            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item p-3 rounded-md flex items-center justify-between cursor-pointer hover:bg-light-hover transition-colors ${chat.id === currentChatId ? 'bg-light-hover' : ''}`;
                chatItem.dataset.id = chat.id;

                const chatDate = new Date(chat.createdAt || chat.id);
                const formattedDate = chatDate.toLocaleDateString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                chatItem.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden flex-1 min-w-0">
                        <i class="fas fa-comment text-primary"></i>
                        <div class="min-w-0">
                            <div class="chat-title truncate font-medium">${chat.title || 'Cuộc trò chuyện mới'}</div>
                            <div class="text-xs text-gray-400 truncate">${formattedDate}</div>
                        </div>
                    </div>
                    <button class="delete-chat-btn text-gray-400 hover:text-red-500 p-1">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                `;

                chatItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-chat-btn')) {
                        loadChat(chat.id);
                        // On mobile, close sidebar after selecting chat
                        if (window.innerWidth <= 768) {
                            sidebar.classList.remove('active');
                        }
                    }
                });

                const deleteBtn = chatItem.querySelector('.delete-chat-btn');
                deleteBtn.addEventListener('click', (e) => {
                    deleteChat(chat.id, e);
                });

                chatHistory.appendChild(chatItem);
            });
        }

        function loadChats() {
            const storedChats = localStorage.getItem('power-ai-chats');
            if (storedChats) {
                const now = Date.now();
                const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;

                chats = JSON.parse(storedChats)
                    .filter(chat => now - new Date(chat.createdAt || chat.id).getTime() < THIRTY_DAYS)
                    .sort((a, b) => new Date(b.createdAt || b.id) - new Date(a.createdAt || a.id));
                
                saveChats();
                renderChatHistory();
            }
        }

        function saveChats() {
            const now = Date.now();
            const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;

            chats = chats.filter(chat => {
                const chatTime = new Date(chat.createdAt || chat.id).getTime();
                return now - chatTime < THIRTY_DAYS;
            });

            localStorage.setItem('power-ai-chats', JSON.stringify(chats));
        }

        function copyToClipboard(button) {
            const code = decodeURIComponent(button.getAttribute('data-code'));
            navigator.clipboard.writeText(code).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Đã sao chép!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            });
        }

        window.addEventListener("beforeunload", () => {
            chats = chats.filter(chat => chat.messages.length > 0);
            saveChats();
        });

        document.addEventListener('DOMContentLoaded', initApp);
        
        window.copyToClipboard = copyToClipboard;
    </script>
</body>
</html>
