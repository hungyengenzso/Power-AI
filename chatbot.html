<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Power AI - Chatbot Tiết kiệm Điện</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
      font-family: 'Arial', sans-serif; 
    }
    
    body { 
      background: #f5f5f5; 
      color: #333; 
      max-width: 100vw;
      overflow-x: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #4caefe, #2d87e0);
      color: white;
      padding: 12px 5%;
      display: flex;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .logo {
      display: flex;
      align-items: center;
      flex-shrink: 0;
      margin-right: auto;
      cursor: pointer;
    }
    
    .logo i {
      font-size: 24px;
      margin-right: 8px;
    }
    
    .logo-text {
      font-weight: bold;
      font-size: 18px;
      white-space: nowrap;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      margin-left: auto;
    }
    
    .search-container {
      display: flex;
      align-items: center;
      margin: 0 15px;
    }
    
    .search-input {
      width: 0;
      padding: 0;
      border-radius: 20px;
      border: none;
      outline: none;
      font-size: 14px;
      transition: all 0.3s ease;
      opacity: 0;
      visibility: hidden;
    }
    
    .search-input.active {
      width: 200px;
      padding: 8px 15px;
      opacity: 1;
      visibility: visible;
      margin-right: 10px;
    }
    
    .search-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      flex-shrink: 0;
      transition: transform 0.2s;
    }
    
    .search-toggle:hover {
      transform: scale(1.1);
    }
    
    .notification {
      position: relative;
      flex-shrink: 0;
      margin-left: 15px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .notification:hover {
      transform: scale(1.1);
    }
    
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4757;
      color: white;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pulse 2s infinite;
    }

    /* Auth buttons */
    .auth-buttons {
      display: flex;
      align-items: center;
      margin-left: 15px;
    }
    
    .auth-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 14px;
      margin-left: 10px;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
    }
    
    .auth-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .auth-icon {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-left: 10px;
      transition: all 0.3s;
    }
    
    .auth-icon:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .user-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-left: 10px;
      cursor: pointer;
      object-fit: cover;
    }

    /* Chat container */
    .chat-container {
      flex: 1;
      display: flex;
      overflow: hidden;
      background-color: #fff;
    }

    /* Sidebar */
    .sidebar {
      width: 250px;
      background-color: #f8f9fa;
      border-right: 1px solid #e9ecef;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 15px;
      border-bottom: 1px solid #e9ecef;
    }

    .new-chat-btn {
      width: 100%;
      padding: 10px;
      background: linear-gradient(135deg, #4caefe, #2d87e0);
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s;
    }

    .new-chat-btn:hover {
      opacity: 0.9;
    }

    .chat-history {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .chat-item {
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 5px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-item:hover {
      background-color: #e9ecef;
    }

    .chat-item.active {
      background-color: #e1e9f5;
    }

    .chat-title {
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-date {
      font-size: 12px;
      color: #6c757d;
    }

    .delete-chat-btn {
      background: none;
      border: none;
      color: #6c757d;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      transition: all 0.3s;
    }

    .delete-chat-btn:hover {
      color: #ff4757;
      background-color: #f8f9fa;
    }

    .sidebar-footer {
      padding: 15px;
      border-top: 1px solid #e9ecef;
      text-align: center;
      font-size: 12px;
      color: #6c757d;
    }

    /* Main chat area */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background-color: #fff;
    }

    .message {
      max-width: 80%;
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 18px;
      line-height: 1.5;
      position: relative;
      word-wrap: break-word;
    }

    .user-message {
      align-self: flex-end;
      background: linear-gradient(135deg, #4caefe, #2d87e0);
      color: white;
      border-radius: 18px 18px 0 18px;
      margin-left: auto;
    }

    .bot-message {
      align-self: flex-start;
      background-color: #f0f4f9;
      border-radius: 18px 18px 18px 0;
      margin-right: auto;
      border: 1px solid #e9ecef;
    }

    .typing-indicator {
      align-self: flex-start;
      background-color: #f0f4f9;
      border-radius: 18px 18px 18px 0;
      margin-right: auto;
      padding: 10px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid #e9ecef;
    }

    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top-color: #2d87e0;
      animation: spin 1s linear infinite;
    }

    /* Input area */
    .input-area {
      padding: 15px;
      border-top: 1px solid #e9ecef;
      background-color: #fff;
    }

    .chat-form {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .message-input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #e9ecef;
      border-radius: 25px;
      font-size: 14px;
      resize: none;
      max-height: 150px;
      outline: none;
      transition: all 0.3s;
    }

    .message-input:focus {
      border-color: #4caefe;
      box-shadow: 0 0 0 2px rgba(76, 174, 254, 0.2);
    }

    .send-button {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4caefe, #2d87e0);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .send-button:hover {
      opacity: 0.9;
      transform: scale(1.05);
    }

    /* Suggestions */
    .suggestions-container {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 10px 15px;
      margin-bottom: 10px;
      scrollbar-width: none;
    }

    .suggestions-container::-webkit-scrollbar {
      display: none;
    }

    .suggestion-chip {
      background-color: #e9ecef;
      border-radius: 20px;
      padding: 8px 15px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.3s;
      flex-shrink: 0;
    }

    .suggestion-chip:hover {
      background: linear-gradient(135deg, #4caefe, #2d87e0);
      color: white;
    }

    /* Code blocks */
    .code-block {
      position: relative;
      margin: 10px 0;
      border-radius: 8px;
      overflow: hidden;
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
    }

    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 10px;
      background-color: #e9ecef;
      font-size: 12px;
      color: #6c757d;
    }

    .copy-code-btn {
      background: none;
      border: none;
      color: #6c757d;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
    }

    .copy-code-btn:hover {
      color: #2d87e0;
    }

    pre {
      margin: 0 !important;
      padding: 10px !important;
      background-color: #f8f9fa !important;
      overflow-x: auto;
    }

    /* Markdown formatting */
    .markdown p {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    .markdown ul, .markdown ol {
      margin-bottom: 10px;
      padding-left: 20px;
    }

    .markdown li {
      margin-bottom: 5px;
    }

    .markdown code:not(pre code) {
      background-color: #e9ecef;
      padding: 2px 4px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 90%;
    }

    .markdown strong {
      font-weight: bold;
    }

    .markdown em {
      font-style: italic;
    }

    .markdown h1, .markdown h2, .markdown h3, .markdown h4 {
      font-weight: bold;
      margin-top: 15px;
      margin-bottom: 10px;
    }

    .markdown h1 {
      font-size: 1.5em;
    }

    .markdown h2 {
      font-size: 1.3em;
    }

    .markdown h3 {
      font-size: 1.1em;
    }

    .markdown blockquote {
      border-left: 4px solid #ced4da;
      padding-left: 15px;
      margin: 10px 0;
      color: #6c757d;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        top: 60px;
        left: -250px;
        bottom: 0;
        z-index: 100;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      }

      .sidebar.active {
        left: 0;
      }

      .sidebar-toggle {
        display: block;
      }

      .auth-btn span {
        display: none;
      }
      
      .auth-btn {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        border-radius: 50%;
      }
      
      .search-input.active {
        width: 150px;
      }
    }

    @media (max-width: 480px) {
      .header {
        padding: 10px 3%;
      }
      
      .search-container {
        margin: 0 8px;
      }
      
      .notification {
        margin-left: 8px;
      }
      
      .auth-buttons {
        margin-left: 8px;
      }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <div class="logo" onclick="goToHome()">
      <i class="fa-solid fa-bolt"></i>
      <span class="logo-text">Power AI</span>
    </div>
    
    <div class="header-right">
      <div class="search-container">
        <input type="text" class="search-input" placeholder="Tìm kiếm...">
        <button class="search-toggle">
          <i class="fas fa-search"></i>
        </button>
      </div>
      
      <div class="notification">
        <i class="fa fa-bell"></i>
        <span class="notification-badge">3</span>
      </div>
      
      <!-- Auth buttons will be inserted here by JavaScript -->
      <div class="auth-buttons" id="authButtons"></div>
    </div>
  </div>
  
  <!-- Chat container -->
  <div class="chat-container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <button class="new-chat-btn" id="new-chat-btn">
          <i class="fas fa-plus"></i>
          <span>Cuộc trò chuyện mới</span>
        </button>
      </div>
      
      <div class="chat-history" id="chat-history">
        <!-- Chat history will be populated here -->
      </div>
      
      <div class="sidebar-footer">
        <p>©2025 THPT Trưng Vương</p>
        <p>Dự án POWER AI</p>
      </div>
    </div>
    
    <!-- Main chat area -->
    <div class="chat-area">
      <div class="messages-container" id="messages-container">
        <div id="chat-messages">
          <!-- Messages will appear here -->
        </div>
      </div>
      
      <div id="typing-indicator" class="typing-indicator hidden">
        <div class="loading-spinner"></div>
        <span>AI đang suy nghĩ, vui lòng đợi giây lát</span>
      </div>
      
      <div id="suggestions-bar" class="hidden">
        <div class="suggestions-container" id="suggestions-container">
          <!-- Suggested questions will appear here -->
        </div>
      </div>
      
      <div class="input-area">
        <form id="chat-form" class="chat-form">
          <textarea 
            id="message-input" 
            class="message-input"
            placeholder="Nhập câu hỏi về tiết kiệm điện..."
            rows="1"
          ></textarea>
          <button 
            id="send-button" 
            type="submit" 
            class="send-button"
          >
            <i class="fas fa-paper-plane"></i>
          </button>
        </form>
      </div>
    </div>
  </div>

  <script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://esm.run/@google/generative-ai"
      }
    }
  </script>
  <script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBXMptx-Tt3dDLmWgRUgyfh2tW2BRGY1KE",
      authDomain: "scan-text-eccf7.firebaseapp.com",
      projectId: "scan-text-eccf7",
      storageBucket: "scan-text-eccf7.appspot.com",
      messagingSenderId: "116481688073",
      appId: "1:116481688073:web:a85a3abcec812a9423eed8",
      measurementId: "G-CRVRVRXHYF"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Check authentication state
    auth.onAuthStateChanged(user => {
      if (!user) {
        // User is not signed in, redirect to index.html
        window.location.href = 'index.html';
      }
    });

    const API_KEY = "AIzaSyAn9dMMM5u8dEGpI8mEzQvdMSuI8KFH8jM";
    const genAI = new GoogleGenerativeAI(API_KEY);
    const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash-thinking-exp-01-21" });

    // DOM elements
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const newChatBtn = document.getElementById('new-chat-btn');
    const chatHistory = document.getElementById('chat-history');
    const typingIndicator = document.getElementById('typing-indicator');
    const suggestionsBar = document.getElementById('suggestions-bar');
    const suggestionsContainer = document.getElementById('suggestions-container');
    const sendButton = document.getElementById('send-button');
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.querySelector('.search-toggle');
    const authButtons = document.getElementById('authButtons');

    let chats = [];
    let currentChatId = null;
    let isSending = false;
    let typingInterval = null;
    let isStopped = false;

    // Energy-related keywords
    const energyKeywords = [
      "điện", "tiết kiệm", "năng lượng", "điện năng", "công suất", "thiết bị", 
      "hóa đơn", "EVN", "điện lực", "tính toán", "chi phí", "sử dụng", 
      "công tơ", "kWh", "W", "kW", "đèn", "tủ lạnh", "máy lạnh", 
      "quạt", "TV", "máy giặt", "bình nóng lạnh", "inverter", "công nghệ", 
      "xanh", "tái tạo", "mặt trời", "gió", "thủy điện", "nhiệt điện", 
      "phí điện", "bậc thang", "giá điện", "điện sinh hoạt", "điện kinh doanh", 
      "điện sản xuất", "cắt giảm", "tối ưu", "hiệu suất", "tiêu thụ", 
      "đo lường", "kiểm tra", "đánh giá", "so sánh", "khuyến nghị", 
      "giải pháp", "tư vấn", "hướng dẫn", "cách tính", "công thức", 
      "chỉ số", "đồng hồ", "smart meter", "thông minh", "tự động", 
      "điều khiển", "hẹn giờ", "cảm biến", "ánh sáng", "nhiệt độ", 
      "độ ẩm", "thông gió", "cách nhiệt", "vật liệu", "kiến trúc", 
      "xây dựng", "thiết kế", "lắp đặt", "bảo trì", "vệ sinh", 
      "nâng cấp", "thay thế", "mua sắm", "lựa chọn", "tiêu chuẩn", 
      "chứng chỉ", "ENERGY STAR", "tiết kiệm điện", "giảm tiêu thụ", 
      "tối ưu hóa", "hiệu quả năng lượng", "quản lý điện", "kiểm soát", 
      "phân tích", "báo cáo", "thống kê", "xu hướng", "biểu đồ", 
      "theo dõi", "giám sát", "cảnh báo", "thông báo", "khuyến cáo", "chào"
    ];

    function isEnergyQuestion(question) {
      const lowerQuestion = question.toLowerCase();
      return energyKeywords.some(keyword => lowerQuestion.includes(keyword.toLowerCase()));
    }

    function generateSuggestions(messages) {
      const userMessages = messages.filter(msg => msg.role === "user");
      if (userMessages.length === 0) {
        return [
          "Cách tính tiền điện theo bậc thang?",
          "Làm sao để tiết kiệm điện cho máy lạnh?",
          "Công thức tính công suất điện tiêu thụ?",
          "So sánh đèn LED và đèn compact"
        ];
      }
      
      // Simple logic to generate follow-up questions based on previous messages
      const lastMessage = userMessages[userMessages.length - 1].content;
      
      if (lastMessage.includes("tính")) {
        return [
          "Bạn có thể hướng dẫn chi tiết cách tính này không?",
          "Công thức này áp dụng cho những thiết bị nào?",
          "Có cách nào tối ưu hóa việc tính toán không?"
        ];
      } else if (lastMessage.includes("tiết kiệm")) {
        return [
          "Những thiết bị nào tiêu thụ nhiều điện nhất?",
          "Mẹo tiết kiệm điện cho từng loại thiết bị",
          "Công nghệ Inverter có thực sự tiết kiệm điện?"
        ];
      } else if (lastMessage.includes("thiết bị")) {
        return [
          "Cách chọn thiết bị tiết kiệm điện",
          "Bảng so sánh công suất các thiết bị phổ biến",
          "Tuổi thọ và hiệu suất năng lượng của thiết bị"
        ];
      }
      
      return [
        "Bạn có thể giải thích rõ hơn về điều này không?",
        "Có giải pháp nào tối ưu hơn không?",
        "Tôi nên làm gì để áp dụng điều này hiệu quả?"
      ];
    }

    function initApp() {
      loadChats();
      setupEventListeners();
      setupTextareaAutoResize();

      if (chats.length === 0) {
        createNewChat();
      } else {
        loadChat(chats[0].id);
      }

      // Setup auth buttons
      setupAuthButtons();
    }

    function setupAuthButtons() {
      auth.onAuthStateChanged(user => {
        if (user) {
          // User is signed in
          authButtons.innerHTML = `
            <button class="auth-btn" onclick="logout()" title="Đăng xuất">
              <i class="fas fa-sign-out-alt"></i>
              ${isMobile() ? '' : '<span>Đăng xuất</span>'}
            </button>
            ${user.photoURL ? 
              `<img src="${user.photoURL}" class="user-avatar" title="${user.displayName || user.email}">` : 
              `<span class="auth-btn" title="${user.displayName || user.email}">
                <i class="fas fa-user"></i>
                ${isMobile() ? '' : `<span>${user.displayName || user.email.split('@')[0]}</span>`}
              </span>`}
          `;
        } else {
          // User is signed out
          window.location.href = 'index.html';
        }
      });
    }

    function isMobile() {
      return window.innerWidth <= 600;
    }

    function logout() {
      auth.signOut().then(() => {
        window.location.href = 'index.html';
      }).catch(error => {
        console.error('Logout error:', error);
      });
    }

    function goToHome() {
      window.location.href = 'index.html';
    }

    function setupEventListeners() {
      chatForm.addEventListener('submit', handleSubmit);
      messageInput.addEventListener('input', autoResizeTextarea);
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (messageInput.value.trim() !== '') {
            chatForm.dispatchEvent(new Event('submit'));
          }
        }
      });
      newChatBtn.addEventListener('click', createNewChat);
      
      // Setup sidebar toggle
      sidebarToggle.addEventListener('click', () => {
        sidebar.classList.toggle('active');
      });
      
      // Close sidebar when clicking outside
      document.addEventListener('click', (e) => {
        if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
          sidebar.classList.remove('active');
        }
      });
    }

    function setupTextareaAutoResize() {
      messageInput.style.height = 'auto';
      const newHeight = Math.min(messageInput.scrollHeight, 150);
      messageInput.style.height = `${newHeight}px`;
    }

    function autoResizeTextarea() {
      messageInput.style.height = 'auto';
      const newHeight = Math.min(messageInput.scrollHeight, 150);
      messageInput.style.height = `${newHeight}px`;
    }

    async function handleSubmit(e) {
      e.preventDefault();
      const userMessage = messageInput.value.trim();
      if (!userMessage || isSending) return;

      if (!isEnergyQuestion(userMessage)) {
        addMessageToUI("assistant", "Xin lỗi, tôi chỉ trả lời chuyên về các câu hỏi liên quan đến tiết kiệm điện và năng lượng. Bạn có câu hỏi nào về lĩnh vực này không?");
        messageInput.value = "";
        autoResizeTextarea();
        return;
      }

      if (!currentChatId) {
        createNewChat();
        return;
      }

      const currentChat = chats.find(chat => chat.id === currentChatId);
      if (!currentChat) {
        console.error("Không tìm thấy cuộc trò chuyện hiện tại!");
        return;
      }

      isSending = true;
      addMessageToUI("user", userMessage);
      
      // Change send button to stop button
      sendButton.innerHTML = '<div class="loading-spinner"></div>';
      sendButton.setAttribute('data-action', 'stop');
      sendButton.onclick = stopGeneration;

      const greetings = ["chào", "hello"];
      if (greetings.some(greet => userMessage.toLowerCase().includes(greet))) {
        const greetingResponse = "Xin chào, tôi là POWER AI - trợ lý ảo về tiết kiệm điện của trường THPT Trưng Vương. Tôi có thể giúp gì cho bạn về tiết kiệm điện và năng lượng ngay bây giờ?";
        displayTypingMessage(greetingResponse, () => {
          if (!isStopped) {
            currentChat.messages.push({ 
              role: "assistant", 
              content: greetingResponse,
              timestamp: new Date().toISOString()
            });
            saveChats();
            updateSuggestions(currentChat.messages);
          }
        });
        messageInput.value = "";
        autoResizeTextarea();
        isSending = false;
        resetSendButton();
        return;
      }

      currentChat.messages.push({ 
        role: "user", 
        content: userMessage,
        timestamp: new Date().toISOString()
      });

      saveChats();
      updateChatTitle(currentChat);

      messageInput.value = "";
      autoResizeTextarea();
      typingIndicator.classList.remove("hidden");
      isStopped = false;

      try {
        const chatSession = model.startChat({
          history: currentChat.messages.map(msg => ({
            role: msg.role === "user" ? "user" : "model",
            parts: [{ text: msg.content }]
          })),
          generationConfig: {
            maxOutputTokens: 2000,
            temperature: 0.9,
            topP: 0.1,
            topK: 16,
          }
        });

        const result = await chatSession.sendMessage(userMessage);
        const response = await result.response;
        const botReply = response.text();

        displayTypingMessage(botReply, () => {
          if (!isStopped) {
            currentChat.messages.push({ 
              role: "assistant", 
              content: botReply,
              timestamp: new Date().toISOString()
            });
            saveChats();
            updateSuggestions(currentChat.messages);
          }
        });
      } catch (error) {
        console.error("Lỗi: ", error);
        addMessageToUI("assistant", "Lỗi kết nối! Vui lòng thử lại sau.");
      } finally {
        isSending = false;
        typingIndicator.classList.add("hidden");
        resetSendButton();
        scrollToBottom();
      }
    }

    function stopGeneration(e) {
      e.preventDefault();
      isStopped = true;
      if (typingInterval) {
        clearInterval(typingInterval);
        typingInterval = null;
      }
      resetSendButton();
    }

    function resetSendButton() {
      sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
      sendButton.setAttribute('data-action', 'send');
      sendButton.onclick = null;
    }

    function updateSuggestions(messages) {
      const suggestions = generateSuggestions(messages);
      suggestionsContainer.innerHTML = '';
      
      if (suggestions.length > 0) {
        suggestions.forEach(suggestion => {
          const chip = document.createElement('div');
          chip.className = 'suggestion-chip';
          chip.textContent = suggestion;
          chip.addEventListener('click', () => {
            messageInput.value = suggestion;
            messageInput.focus();
            autoResizeTextarea();
          });
          suggestionsContainer.appendChild(chip);
        });
        suggestionsBar.classList.remove('hidden');
      } else {
        suggestionsBar.classList.add('hidden');
      }
    }

    function displayTypingMessage(content, callback) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'bot-message message';
      messageDiv.innerHTML = '<div class="message-content"></div>';
      chatMessages.appendChild(messageDiv);
      scrollToBottom();

      let i = 0;
      const speed = 10;
      const contentDiv = messageDiv.querySelector('.message-content');

      if (typingInterval) clearInterval(typingInterval);
      
      typingIndicator.classList.remove("hidden");
      typingInterval = setInterval(() => {
        if (isStopped) {
          clearInterval(typingInterval);
          typingInterval = null;
          contentDiv.innerHTML = formatMessage(content.substring(0, i));
          typingIndicator.classList.add("hidden");
          if (callback) callback();
          return;
        }

        if (i < content.length) {
          contentDiv.innerHTML = formatMessage(content.substring(0, i + 1));
          i++;
          scrollToBottom();
        } else {
          clearInterval(typingInterval);
          typingInterval = null;
          typingIndicator.classList.add("hidden");
          if (callback) callback();
        }
      }, speed);
    }

    function addMessageToUI(role, content) {
      const messageDiv = document.createElement('div');
      messageDiv.className = role === 'user' ? 'user-message message' : 'bot-message message';
      
      const formattedContent = formatMessage(content);
      messageDiv.innerHTML = `<div class="message-content">${formattedContent}</div>`;
      
      chatMessages.appendChild(messageDiv);
      scrollToBottom();
    }

    function formatMessage(content) {
      if (!content) return '';

      let formatted = content.replace(/```([\w]*)\n([\s\S]*?)```/g, (match, lang, code) => {
        const langDisplay = lang ? lang : 'text';
        return `<div class="code-block">
          <div class="code-header flex justify-between items-center px-3 py-2 bg-gray-100 text-gray-600 text-xs rounded-t-md">
            <span>${langDisplay}</span>
            <button class="copy-code-btn hover:text-primary" onclick="copyToClipboard(this)" data-code="${encodeURIComponent(code.trim())}">
              <i class="fas fa-copy"></i> Copy code
            </button>
          </div>
          <pre><code class="language-${lang || 'text'}">${escapeHtml(code.trim())}</code></pre>
        </div>`;
      });

      formatted = formatted.replace(/\|(.+)\|\n\|(?:[-:]+\|)+\n((?:\|.+\|\n)+)/g, (match) => {
        return `<div class="overflow-x-auto"><table class="w-full">
          ${match.replace(/\|(.+)\|\n\|(?:[-:]+\|)+\n/, (header) => {
            const headerCells = header.split('|').slice(1, -1);
            return `<thead><tr>${headerCells.map(cell => `<th class="px-4 py-2">${cell.trim()}</th>`).join('')}</tr></thead>`;
          })}
          <tbody>
            ${match.split('\n').slice(2).filter(Boolean).map(row => {
              const cells = row.split('|').slice(1, -1);
              return `<tr>${cells.map(cell => `<td class="px-4 py-2">${cell.trim()}</td>`).join('')}</tr>`;
            }).join('')}
          </tbody>
        </table></div>`;
      });

      formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      formatted = formatted.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      formatted = formatted.replace(/`([^`]+)`/g, '<code class="bg-gray-100 px-1 py-0.5 rounded">$1</code>');

      formatted = formatted.split('\n\n').map(paragraph => {
        if (paragraph.trim().startsWith('<') && paragraph.trim().endsWith('>')) {
          return paragraph;
        }
        return `<p>${paragraph}</p>`;
      }).join('');

      formatted = formatted.replace(/\n(?![<])/g, '<br>');

      return formatted;
    }

    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    function scrollToBottom() {
      setTimeout(() => {
        const container = document.getElementById('messages-container');
        container.scrollTop = container.scrollHeight;
      }, 100);
    }

    function createNewChat() {
      const newChat = {
        id: Date.now().toString(),
        title: 'Cuộc trò chuyện mới',
        messages: [],
        createdAt: new Date().toISOString()
      };

      chats.unshift(newChat);
      saveChats();
      renderChatHistory();
      loadChat(newChat.id);
      
      messageInput.focus();
      suggestionsBar.classList.add('hidden');
    }

    function loadChat(chatId) {
      currentChatId = chatId;

      document.querySelectorAll('.chat-item').forEach(item => {
        if (item.dataset.id === chatId) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });

      chatMessages.innerHTML = '';

      const currentChat = chats.find(chat => chat.id === chatId);
      if (!currentChat) return;

      if (currentChat.messages.length > 0) {
        currentChat.messages.forEach(message => {
          addMessageToUI(message.role, message.content);
        });
        updateSuggestions(currentChat.messages);
      } else {
        suggestionsBar.classList.add('hidden');
      }
      
      scrollToBottom();
    }

    function deleteChat(chatId, event) {
      event.stopPropagation();
      chats = chats.filter(chat => chat.id !== chatId);
      saveChats();
      renderChatHistory();

      if (chatId === currentChatId) {
        if (chats.length > 0) {
          loadChat(chats[0].id);
        } else {
          createNewChat();
        }
      }
    }

    function updateChatTitle(chat) {
      if (!chat || !chat.messages || chat.messages.length === 0) {
        chat.title = "Cuộc trò chuyện mới";
        saveChats();
        renderChatHistory();
        return;
      }

      const firstUserMessage = chat.messages.find(msg => msg.role === "user");
      if (firstUserMessage) {
        let title = firstUserMessage.content.substring(0, 40);
        if (firstUserMessage.content.length > 40) {
          title += "...";
        }
        chat.title = title || "Cuộc trò chuyện mới";
      } else {
        chat.title = "Cuộc trò chuyện mới";
      }

      saveChats();
      renderChatHistory();
    }

    function renderChatHistory() {
      chatHistory.innerHTML = '';

      if (chats.length === 0) {
        chatHistory.innerHTML = `
          <div class="text-center p-4 text-gray-400">
            Chưa có cuộc trò chuyện nào
          </div>
        `;
        return;
      }

      chats.forEach(chat => {
        const chatItem = document.createElement('div');
        chatItem.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
        chatItem.dataset.id = chat.id;

        const chatDate = new Date(chat.createdAt || chat.id);
        const formattedDate = chatDate.toLocaleDateString('vi-VN', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });

        chatItem.innerHTML = `
          <div class="flex items-center gap-2 overflow-hidden flex-1 min-w-0">
            <i class="fas fa-comment text-primary"></i>
            <div class="min-w-0">
              <div class="chat-title truncate">${chat.title || 'Cuộc trò chuyện mới'}</div>
              <div class="chat-date text-xs text-gray-400 truncate">${formattedDate}</div>
            </div>
          </div>
          <button class="delete-chat-btn text-gray-400 hover:text-red-500 p-1">
            <i class="fa-solid fa-trash"></i>
          </button>
        `;

        chatItem.addEventListener('click', (e) => {
          if (!e.target.closest('.delete-chat-btn')) {
            loadChat(chat.id);
            // On mobile, close sidebar after selecting chat
            if (window.innerWidth <= 768) {
              sidebar.classList.remove('active');
            }
          }
        });

        const deleteBtn = chatItem.querySelector('.delete-chat-btn');
        deleteBtn.addEventListener('click', (e) => {
          deleteChat(chat.id, e);
        });

        chatHistory.appendChild(chatItem);
      });
    }

    function loadChats() {
      const storedChats = localStorage.getItem('power-ai-chats');
      if (storedChats) {
        const now = Date.now();
        const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;

        chats = JSON.parse(storedChats)
          .filter(chat => now - new Date(chat.createdAt || chat.id).getTime() < THIRTY_DAYS)
          .sort((a, b) => new Date(b.createdAt || b.id) - new Date(a.createdAt || a.id));
        
        saveChats();
        renderChatHistory();
      }
    }

    function saveChats() {
      const now = Date.now();
      const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;

      chats = chats.filter(chat => {
        const chatTime = new Date(chat.createdAt || chat.id).getTime();
        return now - chatTime < THIRTY_DAYS;
      });

      localStorage.setItem('power-ai-chats', JSON.stringify(chats));
    }

    function copyToClipboard(button) {
      const code = decodeURIComponent(button.getAttribute('data-code'));
      navigator.clipboard.writeText(code).then(() => {
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Đã sao chép!';
        setTimeout(() => {
          button.innerHTML = originalText;
        }, 2000);
      });
    }

    window.addEventListener("beforeunload", () => {
      chats = chats.filter(chat => chat.messages.length > 0);
      saveChats();
    });

    document.addEventListener('DOMContentLoaded', initApp);
    
    window.copyToClipboard = copyToClipboard;
    window.logout = logout;
    window.goToHome = goToHome;
  </script>
</body>
</html>
